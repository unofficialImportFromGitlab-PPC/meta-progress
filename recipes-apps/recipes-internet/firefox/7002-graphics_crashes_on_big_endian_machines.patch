# HG changeset patch
# User Lee Salzman <lsalzman@mozilla.com>
# Date 1462463631 14400
#      Thu May 05 11:53:51 2016 -0400
# Node ID 8da374804a09977c8f89af5e6e0cb37cb074595d
# Parent  29662e28a9c93ac67ee0b8ddfb65a9f29bbf73f5
handle big-endian formats in Cairo format conversions

diff --git a/gfx/2d/HelpersCairo.h b/gfx/2d/HelpersCairo.h
--- a/gfx/2d/HelpersCairo.h
+++ b/gfx/2d/HelpersCairo.h
@@ -155,17 +155,24 @@ GfxFormatToCairoFormat(SurfaceFormat for
       return CAIRO_FORMAT_ARGB32;
     case SurfaceFormat::X8R8G8B8_UINT32:
       return CAIRO_FORMAT_RGB24;
     case SurfaceFormat::A8:
       return CAIRO_FORMAT_A8;
     case SurfaceFormat::R5G6B5_UINT16:
       return CAIRO_FORMAT_RGB16_565;
     default:
-      gfxCriticalError() << "Unknown image format " << (int)format;
+      // _UINT32 formats don't match B8G8R8[AX]8 on big-endian platforms,
+      // and Moz2d uses B8G8R8[AX]8 as if it was _UINT32.
+      // See bug 1269654
+      if (format == SurfaceFormat::B8G8R8X8) {
+        return CAIRO_FORMAT_RGB24;
+      } else if (format != SurfaceFormat::B8G8R8A8) {
+        gfxCriticalError() << "Unknown image format " << (int)format;
+      }
       return CAIRO_FORMAT_ARGB32;
   }
 }
 
 static inline cairo_content_t
 GfxFormatToCairoContent(SurfaceFormat format)
 {
   switch (format)
@@ -173,17 +180,21 @@ GfxFormatToCairoContent(SurfaceFormat fo
     case SurfaceFormat::A8R8G8B8_UINT32:
       return CAIRO_CONTENT_COLOR_ALPHA;
     case SurfaceFormat::X8R8G8B8_UINT32:
     case SurfaceFormat::R5G6B5_UINT16:  //fall through
       return CAIRO_CONTENT_COLOR;
     case SurfaceFormat::A8:
       return CAIRO_CONTENT_ALPHA;
     default:
-      gfxCriticalError() << "Unknown image content format " << (int)format;
+      if (format == SurfaceFormat::B8G8R8X8) {
+        return CAIRO_CONTENT_COLOR;
+      } else if (format != SurfaceFormat::B8G8R8A8) {
+        gfxCriticalError() << "Unknown image content format " << (int)format;
+      }
       return CAIRO_CONTENT_COLOR_ALPHA;
   }
 }
 
 static inline cairo_line_join_t
 GfxLineJoinToCairoLineJoin(JoinStyle style)
 {
   switch (style)
